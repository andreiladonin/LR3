<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Собери звёзды!</title>
  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <!-- MediaPipe Hands -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    #videoCanvas { position: absolute; top: 0; left: 0; z-index: 100; opacity: 0.5; }
    video { display: none; }
    a-scene { z-index: 0; }
    #scoreText { 
      position: absolute; 
      top: 10px; 
      left: 10px; 
      color: white; 
      font-size: 24px; 
      z-index: 200; 
      font-family: Arial, sans-serif;
    }
    #timerText { 
      position: absolute; 
      top: 10px; 
      right: 10px; 
      color: white; 
      font-size: 24px; 
      z-index: 200; 
      font-family: Arial, sans-serif;
    }
  </style>
</head>
<body>
  <video id="myvideo" autoplay playsinline></video>
  <canvas id="videoCanvas"></canvas>
  <div id="scoreText">Счёт: 0</div>
  <div id="timerText">Время: 30</div>

  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true;"
    webxr="requiredFeatures: local-floor;"
  >
    <a-sky color="#1E90FF"></a-sky>
    <!-- Ловушка (зелёное кольцо) -->
    <a-torus
      id="catcher"
      position="0 0 -1"
      radius="0.2"
      radius-tubular="0.02"
      color="green"
      material="opacity: 0.8;"
    ></a-torus>
    <!-- Камера -->
    <a-entity camera look-controls position="0 0 0"></a-entity>
  </a-scene>

  <script>
    if (!navigator.xr) {
      console.error("WebXR not supported by this browser/device.");
      alert("WebXR not supported. Falling back to 3D mode.");
    } else {
      navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
        if (!supported) {
          console.error("Immersive AR not supported by this browser/device.");
          alert("Immersive AR not supported. Falling back to 3D mode.");
        }
      }).catch((err) => {
        console.error("WebXR support check failed:", err);
        alert("WebXR check failed: " + err.message);
      });
    }

    const video = document.getElementById("myvideo");
    const canvas = document.getElementById("videoCanvas");
    const ctx = canvas.getContext("2d");

    const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${file}` });
    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 0, // Уменьшаем сложность для повышения FPS
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    let isHandClosed = false;
    let score = 0;
    let timeLeft = 30; // 30 секунд на игру
    let gameRunning = true;

    const catcher = document.getElementById("catcher");
    const scoreText = document.getElementById("scoreText");
    const timerText = document.getElementById("timerText");
    const stars = []; // Массив звёзд

    // Функция для создания звезды
    function createStar() {
      const star = document.createElement("a-sphere");
      star.setAttribute("id", `star-${stars.length}`);
      star.setAttribute("radius", "0.1");
      star.setAttribute("color", "yellow");
      star.setAttribute("material", "opacity: 0.9");

      // Случайная начальная позиция
      const x = (Math.random() - 0.5) * 4; // От -2 до 2
      const y = (Math.random() - 0.5) * 4; // От -2 до 2
      star.setAttribute("position", `${x} ${y} -3`);

      // Анимация движения звезды к игроку
      star.setAttribute("animation", `property: position; to: ${x} ${y} 0; dur: 5000; loop: true; easing: linear`);

      document.querySelector("a-scene").appendChild(star);
      stars.push(star);
    }

    // Создаём звёзды каждые 2 секунды
    setInterval(() => {
      if (gameRunning && stars.length < 5) { // Ограничим максимум 5 звёзд одновременно
        createStar();
      }
    }, 2000);

    // Таймер
    setInterval(() => {
      if (gameRunning) {
        timeLeft--;
        timerText.textContent = `Время: ${timeLeft}`;
        if (timeLeft <= 0) {
          gameRunning = false;
          alert(`Игра окончена! Ваш счёт: ${score}`);
        }
      }
    }, 1000);

    hands.onResults((results) => {
      ctx.save();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      if (results.multiHandLandmarks && gameRunning) {
        for (const landmarks of results.multiHandLandmarks) {
          // Рисуем ключевые точки руки
          for (const landmark of landmarks) {
            const x = landmark.x * canvas.width;
            const y = landmark.y * canvas.height;
            ctx.beginPath();
            ctx.arc(x, y, 5, 0, 2 * Math.PI);
            ctx.fillStyle = "green";
            ctx.fill();
          }

          // Определяем жест: открытая/закрытая ладонь
          const thumbTip = landmarks[4];
          const indexTip = landmarks[8];
          const distance = Math.sqrt(
            Math.pow(thumbTip.x - indexTip.x, 2) + Math.pow(thumbTip.y - indexTip.y, 2)
          );
          isHandClosed = distance < 0.15;

          // Позиция руки (центр ладони)
          const handX = landmarks[0].x; // От 0 до 1
          const handY = landmarks[0].y; // От 0 до 1

          // Перемещаем ловушку в соответствии с рукой
          const mappedX = (handX - 0.5) * 4; // От -2 до 2
          const mappedY = -(handY - 0.5) * 4; // От -2 до 2 (инвертируем Y)
          catcher.setAttribute("position", `${mappedX} ${mappedY} -1`);

          // Проверка столкновения со звёздами
          if (isHandClosed) {
            stars.forEach((star, index) => {
              const starPos = star.getAttribute("position");
              const catcherPos = catcher.getAttribute("position");
              const dist = Math.sqrt(
                Math.pow(starPos.x - catcherPos.x, 2) +
                Math.pow(starPos.y - catcherPos.y, 2)
              );

              if (dist < 0.3) { // Если ловушка ближе 0.3 единиц к звезде
                star.parentNode.removeChild(star); // Удаляем звезду
                stars.splice(index, 1); // Удаляем из массива
                score++;
                scoreText.textContent = `Счёт: ${score}`;
              }
            });
          }
        }
      }
      ctx.restore();
    });

    async function startCamera() {
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        console.log("Available cameras:", videoDevices);

        let videoConstraints = { width: 640, height: 480 }; // Уменьшаем разрешение для повышения FPS
        
        const rearCamera = videoDevices.find(device => 
          device.label.toLowerCase().includes('back') || 
          device.label.toLowerCase().includes('rear') || 
          device.label.toLowerCase().includes('environment')
        );

        if (rearCamera) {
          console.log("Using rear camera:", rearCamera.label);
          videoConstraints.deviceId = { exact: rearCamera.deviceId };
        } else {
          console.warn("Rear camera not found, falling back to default camera.");
          alert("Rear camera not found. Using default camera. Switch to rear camera if possible.");
          videoConstraints.facingMode = "environment";
        }

        const stream = await navigator.mediaDevices.getUserMedia({
          video: videoConstraints
        });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play();
          processFrame();
        };
      } catch (err) {
        console.error("Camera start error:", err);
        alert("Failed to start camera: " + err.message);
      }
    }

    async function processFrame() {
      await hands.send({ image: video });
      requestAnimationFrame(processFrame);
    }

    startCamera();

    window.addEventListener("resize", () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    });
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const scene = document.querySelector("a-scene");
    scene.addEventListener("loaded", () => {
      console.log("A-Frame scene loaded");
    });
    scene.addEventListener("enter-vr", () => {
      console.log("Entered AR mode");
      alert("AR mode activated! Catch the stars with your hand!");
    });
    scene.addEventListener("exit-vr", () => {
      console.log("Exited AR mode");
    });
    scene.addEventListener("arError", (e) => {
      console.error("AR error:", e.detail);
      alert("AR failed: " + e.detail);
    });

    scene.addEventListener("renderstart", () => {
      console.log("Rendering started. Game should be visible.");
    });

    setTimeout(() => {
      if (!scene.is('rendering')) {
        console.warn("Rendering not started. Forcing scene render.");
        scene.setAttribute('renderer', 'logarithmicDepthBuffer: true');
      }
    }, 2000);
  </script>
</body>
</html>