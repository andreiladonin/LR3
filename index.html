<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR 3D Object with Gesture Control</title>
  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <!-- MediaPipe Hands -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>
  <style>
    body { margin: 0; overflow: hidden; }
    #videoCanvas { position: absolute; top: 0; left: 0; z-index: 100; opacity: 0.5; }
    video { display: none; }
  </style>
</head>
<body>
  <!-- Видео для захвата камеры -->
  <video id="myvideo" autoplay playsinline></video>
  <!-- Канвас для отображения отслеживания рук -->
  <canvas id="videoCanvas"></canvas>

  <!-- A-Frame сцена -->
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="logarithmicDepthBuffer: true;"
    webxr="requiredFeatures: local-floor, hand-tracking;"
  >
    <!-- 3D-объект: куб -->
    <a-box
      id="targetObject"
      position="0 0.5 -1"  <!-- Ближе к камере и чуть выше -->
      rotation="0 0 0"
      scale="0.3 0.3 0.3"
      color="red"
      material="opacity: 0.8;"
    ></a-box>

    <!-- Камера -->
    <a-entity camera look-controls></a-entity>
  </a-scene>

  <script>
    // Проверка загрузки MediaPipe Hands
    if (typeof window.Hands === 'undefined') {
      console.error("MediaPipe Hands not loaded. Ensure the script is loaded correctly.");
      alert("Failed to load MediaPipe Hands. Check console for details.");
    }

    // Инициализация MediaPipe Hands
    const video = document.getElementById("myvideo");
    const canvas = document.getElementById("videoCanvas");
    const ctx = canvas.getContext("2d");

    const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${file}` });
    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });

    let isHandClosed = false;
    let lastHandX = null;

    hands.onResults((results) => {
      // Очистка канваса
      ctx.save();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const targetObject = document.getElementById("targetObject");

      if (results.multiHandLandmarks) {
        for (const landmarks of results.multiHandLandmarks) {
          // Рисуем ключевые точки руки
          for (const landmark of landmarks) {
            const x = landmark.x * canvas.width;
            const y = landmark.y * canvas.height;
            ctx.beginPath();
            ctx.arc(x, y, 5, 0, 2 * Math.PI);
            ctx.fillStyle = "green";
            ctx.fill();
          }

          // Определяем жест: открытая/закрытая ладонь
          const thumbTip = landmarks[4]; // Кончик большого пальца
          const indexTip = landmarks[8]; // Кончик указательного пальца
          const distance = Math.sqrt(
            Math.pow(thumbTip.x - indexTip.x, 2) + Math.pow(thumbTip.y - indexTip.y, 2)
          );
          isHandClosed = distance < 0.1;

          // Центр руки для вращения
          const handX = landmarks[0].x * canvas.width;

          // Управление масштабом
          let scale = parseFloat(targetObject.getAttribute("scale").x);
          if (isHandClosed) {
            scale = Math.max(0.1, scale - 0.01);
          } else {
            scale = Math.min(2.0, scale + 0.01);
          }
          targetObject.setAttribute("scale", `${scale} ${scale} ${scale}`);

          // Управление вращением
          if (lastHandX !== null) {
            const deltaX = handX - lastHandX;
            let rotation = targetObject.getAttribute("rotation");
            rotation.y += deltaX * 100;
            targetObject.setAttribute("rotation", rotation);
          }
          lastHandX = handX;
        }
      } else {
        lastHandX = null;
      }
      ctx.restore();
    });

    // Инициализация камеры с использованием getUserMedia
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "user", width: window.innerWidth, height: window.innerHeight }
        });
        video.srcObject = stream;
        video.onloadedmetadata = () => {
          video.play();
          // Запуск обработки кадров
          processFrame();
        };
      } catch (err) {
        console.error("Camera start error:", err);
        alert("Failed to start camera: " + err.message);
      }
    }

    // Обработка кадров для MediaPipe
    async function processFrame() {
      await hands.send({ image: video });
      requestAnimationFrame(processFrame);
    }

    // Запуск камеры
    startCamera();

    // Адаптация канваса
    window.addEventListener("resize", () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    });
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // Отладка AR
    const scene = document.querySelector("a-scene");
    scene.addEventListener("loaded", () => {
      console.log("A-Frame scene loaded");
    });
    scene.addEventListener("enter-vr", () => {
      console.log("Entered AR mode");
      alert("AR mode activated!");
    });
    scene.addEventListener("exit-vr", () => {
      console.log("Exited AR mode");
    });
    scene.addEventListener("arError", (e) => {
      console.error("AR error:", e.detail);
      alert("AR failed: " + e.detail);
    });
  </script>
</body>
</html>